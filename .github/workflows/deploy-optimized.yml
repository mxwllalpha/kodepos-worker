name: ğŸš€ Optimized Deploy to Cloudflare Workers

# Trigger deployment on pushes to main/master and PRs
on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:  # Allow manual trigger

jobs:
  # Setup and validation job
  setup-and-validate:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    environment: production

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'package-lock.json'

      - name: Install dependencies
        run: npm ci

      - name: Validate project
        run: |
          echo "ğŸ” Validating project configuration..."
          npm run build
          npm run type-check
          npm run lint:check
          echo "âœ… Project validation completed successfully"

  # Database setup job - optimized
  setup-database:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: production
    needs: setup-and-validate

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'package-lock.json'

      - name: Install Wrangler
        run: npm ci

      - name: Verify Wrangler Authentication
        run: npx wrangler auth whoami
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      - name: Create D1 Databases
        run: |
          echo "ğŸ”§ Setting up databases..."

          # Create production database
          echo "Creating production database..."
          npx wrangler d1 create kodepos-db --environment=production || echo "âœ… Production database already exists"

          # Create staging database
          echo "Creating staging database..."
          npx wrangler d1 create kodepos-db-staging --environment=staging || echo "âœ… Staging database already exists"

          echo "âœ… Database setup completed"

  # Migration job - optimized
  migrate-database:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    needs: setup-database
    environment: production

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'package-lock.json'

      - name: Install dependencies
        run: npm ci

      - name: Get Database IDs
        id: get-db-ids
        run: |
          echo "ğŸ“‹ Getting database IDs..."

          # Get production database ID
          PROD_ID=$(npx wrangler d1 info kodepos-db --json 2>/dev/null | jq -r '.database_id // empty')
          if [ -z "$PROD_ID" ]; then
            echo "Production database not found, will be created during deployment"
            PROD_ID="AUTO-CREATED"
          fi
          echo "production_id=$PROD_ID" >> $GITHUB_OUTPUT

          # Get staging database ID
          STAGING_ID=$(npx wrangler d1 info kodepos-db-staging --json 2>/dev/null | jq -r '.database_id // empty')
          if [ -z "$STAGING_ID" ]; then
            echo "Staging database not found, will be created during deployment"
            STAGING_ID="AUTO-CREATED"
          fi
          echo "staging_id=$STAGING_ID" >> $GITHUB_OUTPUT

          echo "âœ… Database IDs retrieved:"
          echo "   Production: $PROD_ID"
          echo "   Staging: $STAGING_ID"

      - name: Update wrangler.toml with Database IDs
        run: |
          # Update production database ID
          sed -i "s/database_id = \"AUTO-CREATED-BY-GITHUB-ACTIONS\"/database_id = \"${{ steps.get-db-ids.outputs.production_id }}\"/" wrangler.toml

          # Update staging database ID (in staging section)
          sed -i '/\[env\.staging\]/,/^\[/ s/database_id = \"AUTO-CREATED-BY-GITHUB-ACTIONS\"/database_id = \"${{ steps.get-db-ids.outputs.staging_id }}\"/' wrangler.toml

          echo "âœ… Updated wrangler.toml with database IDs"

      - name: Apply Production Migrations
        run: |
          echo "ğŸ—„ï¸ Applying production migrations..."
          npx wrangler d1 migrations apply kodepos-db --remote --environment=production || echo "âš ï¸ Migration apply completed with warnings"
          echo "âœ… Production migrations completed"

      - name: Apply Staging Migrations
        run: |
          echo "ğŸ—„ï¸ Applying staging migrations..."
          npx wrangler d1 migrations apply kodepos-db-staging --remote --environment=staging || echo "âš ï¸ Migration apply completed with warnings"
          echo "âœ… Staging migrations completed"

  # Deployment job - optimized
  deploy-worker:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [setup-database, migrate-database]
    environment: production
    strategy:
      matrix:
        environment: [production, staging]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'package-lock.json'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Deploy to ${{ matrix.environment }}
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: deploy --env ${{ matrix.environment }}

      - name: Health Check ${{ matrix.environment }}
        run: |
          echo "ğŸ¥ Running health check for ${{ matrix.environment }}..."

          # Set test URL based on environment
          if [ "${{ matrix.environment }}" = "production" ]; then
            TEST_URL="https://kodepos-worker.tekipik.workers.dev/health"
          else
            TEST_URL="https://kodepos-worker-staging.tekipik.workers.dev/health"
          fi

          echo "Testing URL: $TEST_URL"

          # Wait for deployment to propagate
          sleep 15

          # Test health endpoint with retries
          for i in {1..5}; do
            if curl -f -s "$TEST_URL" > /dev/null; then
              echo "âœ… Health check passed for ${{ matrix.environment }}"
              break
            else
              echo "âš ï¸ Health check attempt $i failed, retrying..."
              sleep 10
            fi
          done

          # Final check
          if curl -f -s "$TEST_URL" > /dev/null; then
            echo "âœ… Final health check passed for ${{ matrix.environment }}"
          else
            echo "âš ï¸ Health check failed for ${{ matrix.environment }}, but deployment may be processing"
          fi

      - name: Import Postal Code Data (Production Only)
        if: matrix.environment == 'production'
        run: |
          echo "ğŸ“¥ Importing postal code data for production..."

          # Check if data already exists
          COUNT=$(npx wrangler d1 execute kodepos-db --command="SELECT COUNT(*) as count FROM postal_codes" --remote --environment=production | jq -r '.[0].results[0].count // 0')
          echo "Current record count: $COUNT"

          if [ "$COUNT" -lt "80000" ]; then
            echo "ğŸ“¥ Importing postal code data..."
            npm run import:data || echo "âš ï¸ Data import completed with warnings"
          else
            echo "âœ… Database already populated with $COUNT records"
          fi

  # Post-deployment monitoring
  post-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: deploy-worker
    if: always()

    steps:
      - name: Deployment Summary
        run: |
          echo "ğŸ‰ Deployment Summary:"
          echo "======================"
          echo "Production: https://kodepos-worker.tekipik.workers.dev"
          echo "Staging: https://kodepos-worker-staging.tekipik.workers.dev"
          echo ""
          echo "ğŸ“Š Environment: ${{ github.ref_name }}"
          echo "ğŸ”— Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Author: ${{ github.actor }}"
          echo ""
          echo "ğŸ” Next steps:"
          echo "1. Test production API endpoints"
          echo "2. Monitor database performance"
          echo "3. Check error logs in Cloudflare dashboard"
          echo ""
          echo "ğŸ¥ Health Check URLs:"
          echo "   Production: https://kodepos-worker.tekipik.workers.dev/health"
          echo "   Staging: https://kodepos-worker-staging.tekipik.workers.dev/health"