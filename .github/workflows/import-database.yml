name: Import Database

on:
  workflow_dispatch:
    inputs:
      force_import:
        description: 'Force reimport of all data'
        required: false
        default: 'false'
        type: boolean

jobs:
  import-data:
    runs-on: ubuntu-latest
    name: Import Postal Code Database

    permissions:
      contents: read
      id-token: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Check D1 database
      run: |
        echo "Checking D1 database status..."
        npx wrangler d1 list || echo "No databases found"

    - name: Create D1 database if needed
      run: |
        # Check if database exists
        if ! npx wrangler d1 list | grep -q "kodepos-db"; then
          echo "Creating D1 database..."
          npx wrangler d1 create kodepos-db
        else
          echo "D1 database already exists"
        fi

    - name: Run database migrations
      run: |
        echo "Running database migrations..."
        npx wrangler d1 migrations apply kodepos-db --remote

    - name: Check existing data
      run: |
        echo "Checking existing postal code records..."
        COUNT=$(npx wrangler d1 execute kodepos-db --command="SELECT COUNT(*) as count FROM postal_codes" --remote | jq -r '.[0].results[0].count // 0')
        echo "Current record count: $COUNT"

        if [ "$COUNT" -gt "80000" ] && [ "${{ github.event.inputs.force_import }}" != "true" ]; then
          echo "Database already populated. Skipping import."
          echo "To force reimport, run the workflow with force_import=true"
          exit 0
        fi

    - name: Import postal code data
      run: |
        echo "Importing postal code data..."
        npm run import:data

    - name: Verify import
      run: |
        echo "Verifying data import..."
        COUNT=$(npx wrangler d1 execute kodepos-db --command="SELECT COUNT(*) as count FROM postal_codes" --remote | jq -r '.[0].results[0].count // 0')
        echo "Final record count: $COUNT"

        if [ "$COUNT" -lt "80000" ]; then
          echo "❌ Import failed: Expected at least 80,000 records, got $COUNT"
          exit 1
        fi

        echo "✅ Data import successful!"

    - name: Test API with imported data
      run: |
        echo "Testing API with imported data..."

        # Deploy to staging for testing
        npx wrangler deploy --env staging

        # Wait for deployment
        sleep 30

        # Test search functionality
        RESPONSE=$(curl -s "https://kodepos-worker-staging.tekipik.workers.dev/api/v1/search?q=Jakarta&limit=5")
        if echo "$RESPONSE" | grep -q '"success":true'; then
          echo "✅ API search test passed"
        else
          echo "❌ API search test failed"
          echo "Response: $RESPONSE"
          exit 1
        fi

        echo "✅ All import verification tests passed"