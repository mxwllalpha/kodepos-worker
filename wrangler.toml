# Kodepos API Indonesia - Cloudflare Workers Configuration
# High-performance Indonesian postal code API with 83,761 records
# Author: Maxwell Alpha - https://github.com/mxwllalpha - mxwllalpha@gmail.com
# Automated Deployment with GitHub Actions + D1 Database Auto-Creation

name = "kodepos-worker"
main = "src/index.ts"
compatibility_date = "2024-11-03"
compatibility_flags = ["nodejs_compat_v2"]

# Environment Variables (Global defaults)
[vars]
ENVIRONMENT = "development"
API_VERSION = "v1"
DATA_SOURCE_VERSION = "2025-11-26"
API_BASE_URL = "http://localhost:8787"
WORKER_NAME = "kodepos-worker-dev"
DATABASE_NAME = "kodepos-db-dev"
CORS_ORIGIN = "*"
RATE_LIMIT_REQUESTS = "100"
RATE_LIMIT_WINDOW = "60"
API_CACHE_TTL = "300"
ENABLE_CACHE = "true"
ENABLE_RATE_LIMITING = "false"
ENABLE_LOGGING = "true"
LOG_LEVEL = "info"

# Development Environment (local)
[env.development]
name = "kodepos-worker-dev"

[[env.development.d1_databases]]
binding = "KODEPOS_DB"
database_name = "kodepos-db-dev"
database_id = "local-development-db"
preview_database_id = "kodepos-db-local"

[env.development.vars]
ENVIRONMENT = "development"
API_BASE_URL = "http://localhost:8787"
WORKER_NAME = "kodepos-worker-dev"
DATABASE_NAME = "kodepos-db-dev"
DEBUG = "true"
RATE_LIMIT_REQUESTS = "10"
API_CACHE_TTL = "300"

# Staging Environment for testing
[env.staging]
name = "kodepos-worker-staging"

[[env.staging.d1_databases]]
binding = "KODEPOS_DB"
database_name = "kodepos-db-staging"
database_id = "AUTO-CREATED-BY-GITHUB-ACTIONS"

[env.staging.vars]
ENVIRONMENT = "staging"
API_BASE_URL = "https://kodepos-worker-staging.tekipik.workers.dev"
WORKER_NAME = "kodepos-worker-staging"
DATABASE_NAME = "kodepos-db-staging"
DEBUG = "true"
CORS_ORIGIN = "https://kodepos-worker-staging.tekipik.workers.dev"
RATE_LIMIT_REQUESTS = "50"
API_CACHE_TTL = "1800"

# Production Environment
[env.production]
name = "kodepos-worker"

[[env.production.d1_databases]]
binding = "KODEPOS_DB"
database_name = "kodepos-db"
database_id = "AUTO-CREATED-BY-GITHUB-ACTIONS"

[env.production.vars]
ENVIRONMENT = "production"
API_BASE_URL = "https://kodepos-worker.tekipik.workers.dev"
WORKER_NAME = "kodepos-worker"
DATABASE_NAME = "kodepos-db"
DEBUG = "false"
CORS_ORIGIN = "https://kodepos-worker.tekipik.workers.dev"
RATE_LIMIT_REQUESTS = "100"
API_CACHE_TTL = "3600"

# Build Configuration
[build]
command = "npm run build"
watch_dir = "src"

# Observability and Monitoring
[observability]
enabled = true

# Triggers (for automated jobs)
[triggers]
crons = ["0 2 * * *"]  # Daily at 2 AM UTC for database maintenance

# Limits and Constraints
[limits]
cpu_ms = 50000  # 50 seconds CPU time

# KV Namespace for caching (optional - uncomment if needed)
# [[kv_namespaces]]
# binding = "KODEPOS_CACHE"
# id = "kodepos-cache"
# preview_id = "kodepos-cache-preview"